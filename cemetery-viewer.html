<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OICA Cemetery Records Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background: linear-gradient(90deg, #d4c5e0 0%, #b8a7c9 100%);
        }

        .header {
            max-width: 98%;
            margin: 0 auto 25px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            background: #e8e8e8;
            border-radius: 5px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #008CBA;
        }

        button.secondary:hover {
            background-color: #007399;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
        }

        .plot-details {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border: 2px solid #4CAF50;
            border-radius: 8px;
        }

        .plot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .plot-title {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }

        .plot-navigation {
            display: flex;
            gap: 10px;
        }

        .nav-button {
            padding: 8px 15px;
            background-color: #666;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .nav-button:hover {
            background-color: #444;
        }

        .plot-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 10px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            font-weight: bold;
            font-size: 17px;
        }

        .monument-images {
            margin: 20px 0;
            padding: 15px;
            background: #e0e0e0;
            border-radius: 5px;
            text-align: center;
        }

        .monument-images h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .image-item {
            flex: 0 0 auto;
        }

        .image-item a {
            display: block;
            border: 4px solid white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .image-item a:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }

        .image-item img {
            display: block;
            width: 150px;
            height: auto;
        }

        .image-caption {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .lots-container {
            margin-top: 20px;
        }

        .lots-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .lots-grid {
            display: flex;
            flex-direction: row;
            gap: 15px;
            overflow-x: auto;
        }

        .lots-grid > * {
            flex: 1;
            min-width: 200px;
        }

        .lot-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .lot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .lot-card.memorial {
            border-color: #9c27b0;
            background: #f3e5f5;
        }

        .lot-card.occupied {
            border-color: #2196F3;
        }

        .lot-card.reserved {
            border-color: #ff9800;
            background: #fff3e0;
        }

        .lot-card.available {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .lot-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .lot-header.memorial {
            color: #7b1fa2;
        }

        .lot-info {
            font-size: 17px;
            color: #666;
            margin-bottom: 10px;
        }

        .occupant {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #2196F3;
        }

        .occupant.reserved {
            border-left-color: #ff9800;
        }

        .occupant.memorial {
            border-left-color: #9c27b0;
        }

        .occupant-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .occupant-details {
            font-size: 17px;
            color: #666;
            line-height: 1.4;
        }

        .empty-lot {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
            font-size: 17px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }

            .plot-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .plot-navigation {
                margin-top: 10px;
            }

            .lots-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>OICA Cemetery Records Viewer</h1>
        <p class="subtitle">Browse cemetery plots and burial records</p>

        <div class="controls">
            <div class="control-group">
                <label for="sectionFilter">Section:</label>
                <select id="sectionFilter">
                    <option value="">All Sections</option>
                </select>
            </div>

            <div class="control-group">
                <label for="plotFilter">Plot:</label>
                <input type="text" id="plotFilter" placeholder="e.g., CYA1, NYB2, UTA3">
            </div>

            <div class="control-group">
                <label for="nameSearch">Name Search:</label>
                <input type="text" id="nameSearch" placeholder="Search by name...">
            </div>

            <div class="control-group button-group">
                <button onclick="applyFilters()">Search</button>
                <button class="secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="results">
            <div class="loading">Loading cemetery records...</div>
        </div>
    </div>

    <script>
        let plotsData = [];
        let lotsData = [];
        let occupantsData = [];
        let sortedPlots = [];
        let currentFilters = {
            section: '',
            plot: '',
            name: ''
        };

        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Load CSV data
        async function loadData() {
            try {
                const [plotsResponse, lotsResponse, occupantsResponse] = await Promise.all([
                    fetch('data/plots.csv'),
                    fetch('data/lots.csv'),
                    fetch('data/occupants.csv')
                ]);

                const plotsText = await plotsResponse.text();
                const lotsText = await lotsResponse.text();
                const occupantsText = await occupantsResponse.text();

                plotsData = parseCSV(plotsText);
                lotsData = parseCSV(lotsText);
                occupantsData = parseCSV(occupantsText);

                // Sort plots for navigation using natural/alphanumeric sorting
                sortedPlots = [...plotsData].sort((a, b) => {
                    return a.plot_id.localeCompare(b.plot_id, undefined, { numeric: true, sensitivity: 'base' });
                });

                console.log(`Loaded ${plotsData.length} plots, ${lotsData.length} lots, and ${occupantsData.length} occupants`);

                populateSectionFilter();

                // Check for URL parameter (from interactive map)
                const plotParam = getUrlParameter('plot');
                if (plotParam) {
                    // Coming from interactive map - show specific plot
                    currentFilters.plot = plotParam.toUpperCase();
                    document.getElementById('plotFilter').value = plotParam.toUpperCase();
                } else {
                    // Default: show Church Yard Plot A1
                    currentFilters.plot = 'CYA1';
                }

                displayResults();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('results').innerHTML =
                    '<div class="error">Error loading cemetery records. Please ensure the CSV files are in the correct location.</div>';
            }
        }

        // Parse CSV data
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];

            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                }
            }

            return data;
        }

        // Parse a CSV line handling quoted values
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            values.push(current.trim());
            return values;
        }

        // Populate section filter dropdown
        function populateSectionFilter() {
            const sections = [...new Set(plotsData.map(p => p.section_name))].sort();
            const select = document.getElementById('sectionFilter');

            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                select.appendChild(option);
            });
        }

        // Apply filters
        function applyFilters() {
            currentFilters.section = document.getElementById('sectionFilter').value;
            const nameSearchValue = document.getElementById('nameSearch').value.trim();
            currentFilters.name = nameSearchValue.toLowerCase();

            // If user is doing a name search, clear the plot field
            if (nameSearchValue) {
                document.getElementById('plotFilter').value = '';
                currentFilters.plot = '';
            } else {
                currentFilters.plot = document.getElementById('plotFilter').value.trim().toUpperCase();
            }

            // Check if name exists in other sections when section filter is active
            if (currentFilters.name && currentFilters.section) {
                checkNameInOtherSections(currentFilters.name, currentFilters.section);
            }

            displayResults();
        }

        // Check if a name exists in sections other than the one being filtered
        function checkNameInOtherSections(searchName, currentSection) {
            const otherSections = new Set();

            // Check occupant names
            occupantsData.forEach(occupant => {
                if (occupant.name.toLowerCase().includes(searchName)) {
                    // Get the lot and plot to find section
                    const lot = lotsData.find(l => l.lot_id === occupant.lot_id);
                    if (lot) {
                        const plot = plotsData.find(p => p.plot_id === lot.plot_id);
                        if (plot && plot.section_name !== currentSection) {
                            otherSections.add(plot.section_name);
                        }
                    }
                }
            });

            // Check purchaser and current_owner fields
            plotsData.forEach(plot => {
                if (plot.section_name !== currentSection) {
                    if ((plot.purchaser && plot.purchaser.toLowerCase().includes(searchName)) ||
                        (plot.current_owner && plot.current_owner.toLowerCase().includes(searchName))) {
                        otherSections.add(plot.section_name);
                    }
                }
            });

            if (otherSections.size > 0) {
                const sectionList = Array.from(otherSections).join(', ');
                alert(`Note: This name also appears in other section(s): ${sectionList}`);
            }
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('sectionFilter').value = '';
            document.getElementById('plotFilter').value = '';
            document.getElementById('nameSearch').value = '';
            currentFilters = { section: '', plot: '', name: '' };
            displayResults();
        }

        // Filter plots based on current filters
        function filterPlots() {
            let filtered = plotsData;

            if (currentFilters.section) {
                filtered = filtered.filter(p => p.section_name === currentFilters.section);
            }

            if (currentFilters.plot) {
                filtered = filtered.filter(p => p.plot_id.includes(currentFilters.plot));
            }

            if (currentFilters.name) {
                const plotsWithMatchingNames = new Set();

                // Search in occupant names
                occupantsData.forEach(occupant => {
                    if (occupant.name.toLowerCase().includes(currentFilters.name)) {
                        // Get lot's plot_id from lotsData
                        const lot = lotsData.find(l => l.lot_id === occupant.lot_id);
                        if (lot) {
                            plotsWithMatchingNames.add(lot.plot_id);
                        }
                    }
                });

                // Search in purchaser and current_owner fields
                plotsData.forEach(plot => {
                    if ((plot.purchaser && plot.purchaser.toLowerCase().includes(currentFilters.name)) ||
                        (plot.current_owner && plot.current_owner.toLowerCase().includes(currentFilters.name))) {
                        plotsWithMatchingNames.add(plot.plot_id);
                    }
                });

                filtered = filtered.filter(p => plotsWithMatchingNames.has(p.plot_id));
            }

            return filtered;
        }

        // Display results
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const filtered = filterPlots();

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">No plots match your search criteria.</div>';
                return;
            }

            let html = '';

            filtered.forEach(plot => {
                html += renderPlot(plot);
            });

            resultsDiv.innerHTML = html;
        }

        // Get prior and next plot IDs
        function getNavigation(plotId) {
            const currentIndex = sortedPlots.findIndex(p => p.plot_id === plotId);
            const priorPlot = currentIndex > 0 ? sortedPlots[currentIndex - 1].plot_id : null;
            const nextPlot = currentIndex < sortedPlots.length - 1 ? sortedPlots[currentIndex + 1].plot_id : null;
            return { priorPlot, nextPlot };
        }

        // Render a single plot
        function renderPlot(plot) {
            const lots = lotsData.filter(l => l.plot_id === plot.plot_id);
            const { priorPlot, nextPlot } = getNavigation(plot.plot_id);

            // Extract plot letter and number from plot_id (e.g., CYA1 -> A1, UTB17 -> B17)
            const plotLetterNumber = plot.plot_id.substring(2); // Remove 2-letter prefix

            let html = `<div class="plot-details">`;

            // Plot header with navigation
            html += `<div class="plot-header">`;
            html += `<div class="plot-title">${plot.section_name} Plot ${plotLetterNumber} Records</div>`;
            html += `<div class="plot-navigation">`;
            if (nextPlot) {
                html += `<a href="#" onclick="goToPlot('${nextPlot}'); return false;" class="nav-button">‚Üê Next</a>`;
            }
            if (priorPlot) {
                html += `<a href="#" onclick="goToPlot('${priorPlot}'); return false;" class="nav-button">Prior ‚Üí</a>`;
            }
            html += `</div></div>`;

            // Plot info
            html += `<div class="plot-info">`;
            html += `<div class="info-item"><div class="info-label">Plot ID:</div><div class="info-value">${plot.plot_id}</div></div>`;
            html += `<div class="info-item"><div class="info-label">Section:</div><div class="info-value">${plot.section_name}</div></div>`;
            if (plot.purchaser) {
                html += `<div class="info-item"><div class="info-label">Purchaser:</div><div class="info-value">${plot.purchaser}</div></div>`;
            }
            if (plot.current_owner) {
                html += `<div class="info-item"><div class="info-label">Current Owner:</div><div class="info-value">${plot.current_owner}</div></div>`;
            }
            html += `</div>`;

            // Monument images
            if (plot.monument_images) {
                // Function to map plot prefix to folder name
                function getFolderFromPrefix(filename) {
                    const prefix = filename.substring(0, 2).toUpperCase();
                    const folderMap = {
                        'CY': 'OICA Church Yard',
                        'IT': 'OICA Intervale Terrace',
                        'NY': 'OICA New Yard',
                        'OY': 'OICA Old Yard',
                        'UT': 'OICA Upper Terrace'
                    };
                    return folderMap[prefix] || 'OICA Church Yard';
                }

                const images = plot.monument_images.split('; ').map(img => img.trim()).filter(img => img);
                html += `<div class="monument-images">`;
                html += `<h3>Monument Images</h3>`;
                html += `<div class="image-gallery">`;
                images.forEach(filename => {
                    if (filename) {
                        const folder = getFolderFromPrefix(filename);
                        const fullPath = `Monument Images/${folder}/${filename}`;
                        html += `<div class="image-item">`;
                        html += `<a href="${fullPath}" target="_blank">`;
                        html += `<img src="${fullPath}" alt="Monument image" loading="lazy">`;
                        html += `</a></div>`;
                    }
                });
                html += `</div>`;
                html += `<div class="image-caption">(click for larger image)</div>`;
                html += `</div>`;
            }

            // Lots
            html += `<div class="lots-container">`;
            html += `<div class="lots-title">Burial Lots</div>`;
            html += `<div class="lots-grid">`;

            // Sort and render lots
            lots.sort((a, b) => parseInt(b.lot_number) - parseInt(a.lot_number)).forEach(lot => {
                html += renderLot(lot, plot.plot_id);
            });

            html += `</div></div>`;
            html += `</div>`;

            return html;
        }

        // Render a single lot
        function renderLot(lot, plotId) {
            // Get occupants for this lot
            const lotOccupants = occupantsData.filter(o => o.lot_id === lot.lot_id);
            const hasOccupants = lotOccupants.length > 0;
            const hasReserved = lotOccupants.some(o => o.status === 'Reserved');
            const hasMemorial = lotOccupants.some(o => o.status === 'Memorial');

            let cardClass = 'lot-card';
            if (hasMemorial) cardClass += ' memorial';
            else if (lot.status === 'Full') cardClass += ' occupied';
            else if (lot.status === 'Partially Occupied' || hasReserved) cardClass += ' reserved';
            else if (lot.status === 'Available') cardClass += ' available';

            let html = `<div class="${cardClass}">`;
            html += `<div class="lot-header ${hasMemorial ? 'memorial' : ''}">`;
            html += `Lot ${lot.lot_number}`;
            html += `</div>`;

            html += `<div class="lot-info">`;
            html += `Burial Rights Purchased: ${lot.purchased_rights}<br>`;
            html += `Available for Purchase: ${lot.remaining_rights}`;
            if (lot.status === 'Available') {
                html += `<br>Status: ${lot.status}`;
            }
            html += `</div>`;

            if (hasOccupants) {
                lotOccupants.forEach(occupant => {
                    const isReserved = occupant.status === 'Reserved';
                    const isMemorial = occupant.status === 'Memorial';
                    const isVeteran = occupant.veteran === 'Yes';
                    const statusClass = isReserved ? 'reserved' : (isMemorial ? 'memorial' : '');
                    html += `<div class="occupant ${statusClass}">`;
                    html += `<div class="occupant-name">`;

                    // Add veteran flag if applicable (always first)
                    if (isVeteran) {
                        html += `üá∫üá∏ `;
                    }

                    // Add status prefix based on occupant status
                    if (isReserved) {
                        html += `üîí Reserved: ${occupant.name}`;
                    } else if (isMemorial) {
                        html += `üïäÔ∏è Memorial: ${occupant.name}`;
                    } else {
                        html += occupant.name;
                    }

                    html += `</div>`;
                    html += `<div class="occupant-details">`;
                    if (occupant.former_name) {
                        html += `Formerly: ${occupant.former_name}<br>`;
                    }
                    if (occupant.birth_date) {
                        html += `Born: ${occupant.birth_date}<br>`;
                    }
                    if (occupant.death_date) {
                        html += `Died: ${occupant.death_date}`;
                    }
                    html += `</div>`;

                    // Display notes in separate block
                    if (occupant.notes) {
                        html += `<div class="occupant-notes" style="font-size: 15px; font-style: italic; color: #666; margin: 10px 0 0 0; padding: 8px; background: #f9f9f9; border-left: 3px solid #999;">`;
                        html += `üìù ${occupant.notes}`;
                        html += `</div>`;
                    }

                    html += `</div>`;
                });
            } else {
                html += `<div class="empty-lot">No occupants</div>`;
            }

            // Display lot notes at the bottom (excluding standard notes)
            if (lot.notes) {
                const notesToDisplay = lot.notes
                    .split(';')
                    .map(n => n.trim())
                    .filter(n => n && !n.includes('Unpurchased') && !n.includes('Memorial/Urn lot'))
                    .join('; ');

                if (notesToDisplay) {
                    html += `<div class="lot-notes" style="font-size: 15px; font-style: italic; color: #666; margin: 10px 0 0 0; padding: 8px; background: #f9f9f9; border-left: 3px solid #999;">`;
                    html += `üìù ${notesToDisplay}`;
                    html += `</div>`;
                }
            }

            html += `</div>`;
            return html;
        }

        // Navigate to a specific plot
        function goToPlot(plotId) {
            // Clear current filters
            clearFilters();

            // Set plot filter to the target plot
            document.getElementById('plotFilter').value = plotId.toUpperCase();

            // Apply filter
            applyFilters();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Handle Enter key in search fields
        document.addEventListener('DOMContentLoaded', () => {
            ['plotFilter', 'nameSearch'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        applyFilters();
                    }
                });
            });

            loadData();
        });
    </script>
</body>
</html>
